<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Analyzer Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .api-setup {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 30px;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin: 20px 30px;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.drag-over {
            border-color: #28a745;
            background: #f0fff0;
        }

        .preview-image {
            max-width: 400px;
            max-height: 400px;
            border-radius: 15px;
            margin: 20px auto;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .analyze-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s;
            font-weight: bold;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 30px;
            text-align: center;
            font-weight: bold;
            animation: fadeIn 0.3s ease-in;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .results {
            display: none;
            margin: 30px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .analysis-section {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            line-height: 1.6;
        }

        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zone-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .zone-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .zone-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .zone-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .recommendation {
            background: white;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .recommendation:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }

        .product-name {
            color: #667eea;
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .product-details {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .medical-alert {
            background: #f8d7da;
            border: 3px solid #dc3545;
            padding: 20px;
            border-radius: 10px;
            color: #721c24;
            margin: 15px 0;
        }

        .medical-safe {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            color: #155724;
            margin-bottom: 15px;
        }

        .disclaimer {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .zone-analysis {
                grid-template-columns: 1fr;
            }
            
            .api-setup, .upload-area, .status {
                margin: 20px 15px;
            }
            
            .results {
                margin: 15px;
            }
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
        .analysis-section p {
            margin-bottom: 10px;
        }

        .analysis-section strong {
            color: #495057;
        }

        /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
        .analyze-btn.loading {
            background: linear-gradient(45deg, #6c757d, #495057);
            cursor: wait;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ Health Analyzer Pro</h1>
            <p>–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∑–¥–æ—Ä–æ–≤'—è –ø–æ —Ñ–æ—Ç–æ —è–∑–∏–∫–∞</p>
        </div>

        <div class="api-setup">
            <h4>ü§ñ Claude API –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</h4>
            <input type="password" id="apiKey" class="api-input" placeholder="sk-ant-api03-..." value="" autocomplete="off">
            <p><small>
            üîë API –∫–ª—é—á: <a href="https://console.anthropic.com/" target="_blank" rel="noopener">console.anthropic.com</a><br>
            üöÄ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Claude 3.5 Sonnet –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É
            </small></p>
        </div>

        <div id="status" class="status info">
            –í–≤–µ–¥—ñ—Ç—å Claude API –∫–ª—é—á —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ —è–∑–∏–∫–∞
        </div>

        <div class="upload-area" id="uploadArea">
            <div style="font-size: 3em; color: #ddd; margin-bottom: 10px;">üì∑</div>
            <h3>–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ —è–∑–∏–∫–∞</h3>
            <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª —Å—é–¥–∏</p>
            <p><small>–ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏: JPG, PNG, WebP (–º–∞–∫—Å. 10MB)</small></p>
            <input type="file" id="fileInput" style="display: none;" accept="image/*">
        </div>

        <img id="previewImage" class="preview-image" alt="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥">
        
        <button id="analyzeBtn" class="analyze-btn" disabled>
            ü§ñ –ê–Ω–∞–ª—ñ–∑ Claude
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>ü§ñ Claude –∞–Ω–∞–ª—ñ–∑—É—î —Ñ–æ—Ç–æ...</h3>
            <p>–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—ñ...</p>
        </div>

        <div id="results" class="results">
            <div class="disclaimer">
                ‚ö†Ô∏è –¶–µ —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª—ñ–∑—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à—Ç—É—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –º–∞—é—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä —ñ –Ω–µ –∑–∞–º—ñ–Ω—é—é—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é –ª—ñ–∫–∞—Ä—è. –ü—Ä–∏ –±—É–¥—å-—è–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –∑—ñ –∑–¥–æ—Ä–æ–≤'—è–º –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –º–µ–¥–∏—á–Ω–æ–≥–æ —Ñ–∞—Ö—ñ–≤—Ü—è.
            </div>

            <div class="analysis-section">
                <h3>üîç –î–µ—Ç–∞–ª—å–Ω–∏–π –≤—ñ–∑—É–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</h3>
                <div id="detailedAnalysis"></div>
            </div>

            <div class="analysis-section">
                <h3>üó∫Ô∏è –ó–æ–Ω–∞–ª—å–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
                <div id="zoneAnalysis" class="zone-analysis"></div>
            </div>

            <div class="analysis-section">
                <h3>üéØ –Ü–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—è –∑–¥–æ—Ä–æ–≤'—è</h3>
                <div id="healthInterpretation"></div>
            </div>

            <div class="analysis-section">
                <h3>üíä –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h3>
                <div id="recommendations"></div>
            </div>

            <div class="analysis-section">
                <h3>üìà –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h3>
                <div id="monitoring"></div>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedFile = null;
        let apiKey = '';
        let isAnalyzing = false;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const elements = {
            apiKeyInput: document.getElementById('apiKey'),
            fileInput: document.getElementById('fileInput'),
            uploadArea: document.getElementById('uploadArea'),
            previewImage: document.getElementById('previewImage'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            status: document.getElementById('status'),
            loading: document.getElementById('loading'),
            results: document.getElementById('results'),
            detailedAnalysis: document.getElementById('detailedAnalysis'),
            zoneAnalysis: document.getElementById('zoneAnalysis'),
            healthInterpretation: document.getElementById('healthInterpretation'),
            recommendations: document.getElementById('recommendations'),
            monitoring: document.getElementById('monitoring')
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initEventListeners() {
            // API –∫–ª—é—á
            elements.apiKeyInput.addEventListener('input', handleApiKeyInput);
            elements.apiKeyInput.addEventListener('paste', handleApiKeyPaste);

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
            elements.uploadArea.addEventListener('dragover', handleDragOver);
            elements.uploadArea.addEventListener('dragleave', handleDragLeave);
            elements.uploadArea.addEventListener('drop', handleDrop);
            elements.fileInput.addEventListener('change', handleFileSelect);

            // –ê–Ω–∞–ª–∏–∑
            elements.analyzeBtn.addEventListener('click', analyzeImage);

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞
            window.addEventListener('beforeunload', (e) => {
                if (isAnalyzing) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function handleApiKeyInput(e) {
            apiKey = e.target.value.trim();
            updateStatus();
        }

        function handleApiKeyPaste(e) {
            setTimeout(() => {
                apiKey = e.target.value.trim();
                updateStatus();
            }, 10);
        }

        function handleDragOver(e) {
            e.preventDefault();
            elements.uploadArea.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            elements.uploadArea.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            elements.uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞
        function handleFile(file) {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                showStatus('error', '‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showStatus('error', '‚ùå –§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä: 10MB');
                return;
            }

            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                elements.previewImage.src = e.target.result;
                elements.previewImage.style.display = 'block';
                updateStatus();
            };
            reader.onerror = function() {
                showStatus('error', '‚ùå –ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É');
            };
            reader.readAsDataURL(file);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus() {
            if (!apiKey) {
                showStatus('error', '‚ùå –í–≤–µ–¥—ñ—Ç—å Claude API –∫–ª—é—á');
                elements.analyzeBtn.disabled = true;
            } else if (!validateApiKey(apiKey)) {
                showStatus('warning', '‚ö†Ô∏è –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç API –∫–ª—é—á–∞. –ú–∞—î –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ "sk-ant-"');
                elements.analyzeBtn.disabled = true;
            } else if (!selectedFile) {
                showStatus('info', 'üì∑ –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ —è–∑–∏–∫–∞ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É');
                elements.analyzeBtn.disabled = true;
            } else {
                showStatus('success', '‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –∞–Ω–∞–ª—ñ–∑—É!');
                elements.analyzeBtn.disabled = false;
            }
        }

        function showStatus(type, message) {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è API –∫–ª—é—á–∞
        function validateApiKey(key) {
            return key.startsWith('sk-ant-') && key.length > 20;
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const base64 = reader.result.split(',')[1];
                        if (!base64) {
                            reject(new Error('–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó —Ñ–∞–π–ª—É'));
                            return;
                        }
                        resolve(base64);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É'));
                reader.readAsDataURL(file);
            });
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞
        async function analyzeImage() {
            if (!selectedFile || !apiKey || isAnalyzing) return;
            
            isAnalyzing = true;
            
            // UI changes
            elements.analyzeBtn.disabled = true;
            elements.analyzeBtn.innerHTML = '‚è≥ –ê–Ω–∞–ª—ñ–∑—É—é...';
            elements.analyzeBtn.classList.add('loading');
            elements.loading.style.display = 'block';
            elements.results.style.display = 'none';
            showStatus('info', 'ü§ñ Claude –∞–Ω–∞–ª—ñ–∑—É—î —Ñ–æ—Ç–æ...');

            try {
                const base64 = await fileToBase64(selectedFile);
                const result = await callClaudeAPI(base64);
                
                displayResults(result);
                showStatus('success', '‚úÖ –ê–Ω–∞–ª—ñ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
                
            } catch (error) {
                console.error('Analysis error:', error);
                handleAnalysisError(error);
            } finally {
                // Restore UI
                isAnalyzing = false;
                elements.loading.style.display = 'none';
                elements.analyzeBtn.disabled = false;
                elements.analyzeBtn.innerHTML = 'ü§ñ –ê–Ω–∞–ª—ñ–∑ Claude';
                elements.analyzeBtn.classList.remove('loading');
            }
        }

        // –í—ã–∑–æ–≤ Claude API
        async function callClaudeAPI(base64) {
            const requestBody = {
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 2500,
                system: createSystemPrompt(),
                messages: [{
                    role: 'user',
                    content: [
                        {
                            type: 'text',
                            text: '–£–í–ê–ñ–ù–û –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –¶–ï –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ —Ñ–æ—Ç–æ —è–∑–∏–∫–∞. –û–ø–∏—à–∏ –©–û –°–ê–ú–ï —Ç–∏ –±–∞—á–∏—à –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ: –∫–æ–ª—ñ—Ä, —Ç–µ–∫—Å—Ç—É—Ä—É, –Ω–∞–ª—ñ—Ç, –≤—ñ–¥–±–∏—Ç–∫–∏ –∑—É–±—ñ–≤, —Ä–æ–∑–º—ñ—Ä. –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–∞–≥–∞–ª—å–Ω—ñ —Ñ—Ä–∞–∑–∏! –î–∞–π JSON –∞–Ω–∞–ª—ñ–∑ —Å–∞–º–µ –¶–¨–û–ì–û —Ñ–æ—Ç–æ.'
                        },
                        {
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: getImageMimeType(selectedFile),
                                data: base64
                            }
                        }
                    ]
                }]
            };

            const response = await fetch('/.netlify/functions/claude', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Error: ${response.status} - ${errorData.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'}`);
            }

            const data = await response.json();
            
            if (!data.content || !data.content[0] || !data.content[0].text) {
                throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ Claude');
            }

            return parseClaudeResponse(data.content[0].text);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
        function createSystemPrompt() {
            return `–¢–∏ –ª—ñ–∫–∞—Ä-–¥—ñ–∞–≥–Ω–æ—Å—Ç, —è–∫–∏–π –∞–Ω–∞–ª—ñ–∑—É—î –ö–û–ù–ö–†–ï–¢–ù–ï —Ñ–æ—Ç–æ —è–∑–∏–∫–∞. 

–û–ë–û–í'–Ø–ó–ö–û–í–û: 
1. –£–í–ê–ñ–ù–û –≤–∏–≤—á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
2. –û–ø–∏—à–∏ –©–û –°–ê–ú–ï —Ç–∏ –±–∞—á–∏—à –Ω–∞ –¶–¨–û–ú–£ —Ñ–æ—Ç–æ
3. –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–∞–≥–∞–ª—å–Ω—ñ —Ñ—Ä–∞–∑–∏ - –æ–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–µ—Ç–∞–ª—ñ

–ê–ª–≥–æ—Ä–∏—Ç–º –∞–Ω–∞–ª—ñ–∑—É –¶–¨–û–ì–û –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–æ—Ç–æ:

üîç –î–ï–¢–ê–õ–¨–ù–ò–ô –í–Ü–ó–£–ê–õ–¨–ù–ò–ô –ê–ù–ê–õ–Ü–ó:
- –ö–æ–ª—ñ—Ä —è–∑–∏–∫–∞ (—Ä–æ–∂–µ–≤–∏–π/—á–µ—Ä–≤–æ–Ω–∏–π/–±–ª—ñ–¥–∏–π/–∑ –Ω–∞–ª—å–æ—Ç–æ–º)
- –¢–µ–∫—Å—Ç—É—Ä–∞ –ø–æ–≤–µ—Ä—Ö–Ω—ñ (–≥–ª–∞–¥–∫–∞/–≥–æ—Ä–±–∏—Å—Ç–∞/–∑ —Ç—Ä—ñ—â–∏–Ω–∞–º–∏)
- –ù–∞–ª—ñ—Ç (—î/–Ω–µ–º–∞—î, –∫–æ–ª—ñ—Ä, —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è)
- –í—ñ–¥–±–∏—Ç–∫–∏ –∑—É–±—ñ–≤ –ø–æ –∫—Ä–∞—è—Ö (—î/–Ω–µ–º–∞—î)
- –†–æ–∑–º—ñ—Ä —Ç–∞ —Ñ–æ—Ä–º–∞ —è–∑–∏–∫–∞
- –°—Ç–∞–Ω —Å–æ—Å–æ—á–∫—ñ–≤
- –ë—É–¥—å-—è–∫—ñ –ø–ª—è–º–∏, –∑–º—ñ–Ω–∏ –∫–æ–ª—å–æ—Ä—É

üö® –ú–ï–î–ò–ß–ù–Ü –¢–†–ò–í–û–ñ–ù–Ü –û–ó–ù–ê–ö–ò:
- –ë—ñ–ª—ñ –ø–ª—è–º–∏, —â–æ –Ω–µ –∑–º–∏–≤–∞—é—Ç—å—Å—è
- –ß–µ—Ä–≤–æ–Ω—ñ/—Ç–µ–º–Ω—ñ –ø–ª—è–º–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ñ–æ—Ä–º–∏
- –í–∏—Ä–∞–∑–∫–∏, —Ä–∞–Ω–∏, –∫—Ä–æ–≤–æ—Ç–æ—á–∏–≤—ñ—Å—Ç—å
- –ê—Å–∏–º–µ—Ç—Ä–∏—á–Ω—ñ –Ω–æ–≤–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è

–§–û–†–ú–ê–¢ –í–Ü–î–ü–û–í–Ü–î–Ü - —Å—É–≤–æ—Ä–æ JSON:
–Ø–∫—â–æ —î —Ç—Ä–∏–≤–æ–∂–Ω—ñ –æ–∑–Ω–∞–∫–∏:
{
  "urgent_medical_attention": true,
  "medical_alert": "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –æ–ø–∏—Å —Ç–æ–≥–æ, —â–æ –≤–∏–¥–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ",
  "concerning_features": ["—â–æ —Å–∞–º–µ –≤–∏–∫–ª–∏–∫–∞—î –∑–∞–Ω–µ–ø–æ–∫–æ—î–Ω–Ω—è"],
  "recommendation": "–¥–æ —è–∫–æ–≥–æ –ª—ñ–∫–∞—Ä—è –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è"
}

–Ø–∫—â–æ —è–∑–∏–∫ –≤–∏–≥–ª—è–¥–∞—î –Ω–æ—Ä–º–∞–ª—å–Ω–æ:
{
  "urgent_medical_attention": false,
  "detailed_analysis": "–¥–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –¶–¨–û–ì–û –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —è–∑–∏–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ",
  "zone_analysis": {
    "tip": "—â–æ –≤–∏–¥–Ω–æ –Ω–∞ –∫—ñ–Ω—á–∏–∫—É –¶–¨–û–ì–û —è–∑–∏–∫–∞", 
    "middle": "—â–æ –≤–∏–¥–Ω–æ –≤ —Ü–µ–Ω—Ç—Ä—ñ –¶–¨–û–ì–û —è–∑–∏–∫–∞",
    "edges": "—â–æ –≤–∏–¥–Ω–æ –ø–æ –∫—Ä–∞—è—Ö –¶–¨–û–ì–û —è–∑–∏–∫–∞",
    "back": "—â–æ –≤–∏–¥–Ω–æ –≤ –∑–∞–¥–Ω—ñ–π —á–∞—Å—Ç–∏–Ω—ñ –¶–¨–û–ì–û —è–∑–∏–∫–∞"
  },
  "health_interpretation": "—â–æ –æ–∑–Ω–∞—á–∞—é—Ç—å –ö–û–ù–ö–†–ï–¢–ù–Ü –æ–∑–Ω–∞–∫–∏ –Ω–∞ –¶–¨–û–ú–£ —Ñ–æ—Ç–æ",
  "wellness_recommendations": [
    {"product": "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –ë–ê–î", "reason": "—á–æ–º—É —Å–∞–º–µ —Ü–µ–π –ë–ê–î –¥–ª—è –¶–ò–• –æ–∑–Ω–∞–∫"}
  ],
  "monitoring": "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –¶–¨–û–ì–û –≤–∏–ø–∞–¥–∫—É",
  "safety_note": "–¶–µ –∞–Ω–∞–ª—ñ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–æ—Ç–æ, –Ω–µ –º–µ–¥–∏—á–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
}`;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ MIME —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function getImageMimeType(file) {
            const type = file.type;
            if (type === 'image/png') return 'image/png';
            if (type === 'image/webp') return 'image/webp';
            return 'image/jpeg'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ Claude
        function parseClaudeResponse(content) {
            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Claude –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤ JSON –≤—ñ–¥–ø–æ–≤—ñ–¥—å');
                }

                // –û—á–∏—â–∞–µ–º JSON –æ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                let cleanJson = jsonMatch[0]
                    .replace(/[\x00-\x1F\x7F]/g, '') // —É–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                    .replace(/\n/g, '\\n')          // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                    .replace(/\r/g, '\\r')          // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤–æ–∑–≤—Ä–∞—Ç—ã –∫–∞—Ä–µ—Ç–∫–∏
                    .replace(/\t/g, '\\t')          // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–∞–±—ã
                    .replace(/\\/g, '\\\\')         // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏
                    .replace(/"/g, '\\"')           // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏
                    .replace(/\\"/g, '"')           // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                    .replace(/\\\\"/g, '\\"');      // –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –¥–≤–æ–π–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

                return JSON.parse(cleanJson);
            } catch (parseError) {
                console.error('JSON Parse Error:', parseError);
                throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ Claude');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–Ω–∞–ª–∏–∑–∞
        function handleAnalysisError(error) {
            let errorMessage = error.message;
            
            if (error.message.includes('API Error: 401')) {
                errorMessage = '–ù–µ–≤—ñ—Ä–Ω–∏–π API –∫–ª—é—á Claude. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å –∫–ª—é—á–∞.';
            } else if (error.message.includes('API Error: 403')) {
                errorMessage = '–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∞ API –∫–ª—é—á–∞.';
            } else if (error.message.includes('API Error: 429')) {
                errorMessage = '–ü–µ—Ä–µ–≤–∏—â–µ–Ω–æ –ª—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
            } else if (error.message.includes('API Error: 500')) {
                errorMessage = '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ Claude. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
            } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                errorMessage = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –∑\'—î–¥–Ω–∞–Ω–Ω—è.';
            }
            
            showStatus('error', `‚ùå ${errorMessage}`);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(data) {
            if (data.urgent_medical_attention) {
                displayMedicalAlert(data);
            } else {
                displayWellnessAnalysis(data);
            }
            
            elements.results.style.display = 'block';
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        function displayMedicalAlert(data) {
            elements.detailedAnalysis.innerHTML = `
                <div class="medical-alert">
                    <h3>üö® –£–í–ê–ì–ê! –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ª—ñ–∫–∞—Ä—è</h3>
                    <p><strong>${data.medical_alert}</strong></p>
                    <p><strong>–í–∏—è–≤–ª–µ–Ω—ñ –æ–∑–Ω–∞–∫–∏:</strong> ${data.concerning_features ? data.concerning_features.join(', ') : '–ü—ñ–¥–æ–∑—Ä—ñ–ª—ñ –∑–º—ñ–Ω–∏'}</p>
                    <p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:</strong> ${data.recommendation}</p>
                    <p style="margin-top: 15px; font-weight: bold;">‚ö†Ô∏è –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ñ –¥–æ–±–∞–≤–∫–∏ –ù–ï –ø—ñ–¥—Ö–æ–¥—è—Ç—å –≤ —Ü—ñ–π —Å–∏—Ç—É–∞—Ü—ñ—ó. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ª—ñ–∫–∞—Ä—è —è–∫–Ω–∞–π—à–≤–∏–¥—à–µ!</p>
                </div>
            `;
            
            elements.zoneAnalysis.innerHTML = '<p style="color: #666;">–ó–æ–Ω–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –ø—Ä–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—ñ –ø—Ä–æ–±–ª–µ–º–Ω–∏—Ö –æ–∑–Ω–∞–∫</p>';
            elements.healthInterpretation.innerHTML = '<p style="color: #666;">–ü–æ—Ç—Ä—ñ–±–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ –º–µ–¥–∏—á–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</p>';
            elements.recommendations.innerHTML = '<p style="color: #666;">–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ñ –¥–æ–±–∞–≤–∫–∏ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—å—Å—è. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ª—ñ–∫–∞—Ä—è –æ–±–æ–≤\'—è–∑–∫–æ–≤–∞.</p>';
            elements.monitoring.innerHTML = '<p style="color: #666;">–ó–∞–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–π–æ–º –¥–æ –ª—ñ–∫–∞—Ä—è</p>';
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ wellness –∞–Ω–∞–ª–∏–∑–∞
        function displayWellnessAnalysis(data) {
            elements.detailedAnalysis.innerHTML = `
                <div class="medical-safe">
                    ‚úÖ –°–µ—Ä–π–æ–∑–Ω–∏—Ö –æ–∑–Ω–∞–∫, —â–æ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –Ω–µ–≥–∞–π–Ω–æ—ó –º–µ–¥–∏—á–Ω–æ—ó –¥–æ–ø–æ–º–æ–≥–∏, –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ
                </div>
                <p>${data.detailed_analysis}</p>
            `;

            // –ó–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
            if (data.zone_analysis) {
                const zoneNames = {
                    tip: 'üëÑ –ö—ñ–Ω—á–∏–∫ —è–∑–∏–∫–∞',
                    middle: 'üçΩÔ∏è –°–µ—Ä–µ–¥–Ω—è —á–∞—Å—Ç–∏–Ω–∞',
                    back: 'üè• –ó–∞–¥–Ω—è —á–∞—Å—Ç–∏–Ω–∞',
                    edges: 'üü° –ë–æ–∫–æ–≤—ñ –∫—Ä–∞—ó'
                };
                
                const zoneHtml = Object.entries(data.zone_analysis).map(([zone, analysis]) => `
                    <div class="zone-card">
                        <h4>${zoneNames[zone] || zone}</h4>
                        <p>${analysis}</p>
                    </div>
                `).join('');
                elements.zoneAnalysis.innerHTML = zoneHtml;
            }

            // –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∑–¥–æ—Ä–æ–≤—å—è
            elements.healthInterpretation.innerHTML = data.health_interpretation || '–ó–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –≤ –º–µ–∂–∞—Ö –Ω–æ—Ä–º–∏ –¥–ª—è wellness –ø—ñ–¥—Ç—Ä–∏–º–∫–∏';

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if (data.wellness_recommendations && data.wellness_recommendations.length > 0) {
                const recommendationsHtml = data.wellness_recommendations.map(rec => `
                    <div class="recommendation">
                        <div class="product-name">üíä ${rec.product}</div>
                        <div class="product-details">
                            <strong>–û–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è:</strong><br>
                            ${rec.reason}
                        </div>
                    </div>
                `).join('');
                elements.recommendations.innerHTML = recommendationsHtml;
            } else {
                elements.recommendations.innerHTML = '<p>–°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –Ω–µ –Ω–∞–¥–∞–Ω—ñ –¥–ª—è —Ü—å–æ–≥–æ –≤–∏–ø–∞–¥–∫—É</p>';
            }

            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            elements.monitoring.innerHTML = `
                <p><strong>‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ:</strong> ${data.safety_note || '–¶–µ wellness –∞–Ω–∞–ª—ñ–∑ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à—Ç—É—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É, –Ω–µ –º–µ–¥–∏—á–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞'}</p>
                <p><strong>üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥:</strong> ${data.monitoring || '–í—ñ–¥—Å—Ç–µ–∂—É–π—Ç–µ –∑–º—ñ–Ω–∏ –ø—Ä–æ—Ç—è–≥–æ–º 2-3 —Ç–∏–∂–Ω—ñ–≤'}</p>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            initEventListeners();
            updateStatus();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            if (!window.fetch || !window.FileReader) {
                showStatus('error', '‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ Chrome, Firefox –∞–±–æ Safari');
                return;
            }
            
            console.log('Health Analyzer Pro initialized successfully');
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>